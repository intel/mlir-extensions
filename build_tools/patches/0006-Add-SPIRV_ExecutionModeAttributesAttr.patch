From ab51a97f5358afe72bfce6483a3416a50dc40018 Mon Sep 17 00:00:00 2001
From: Garra1980 <igor.zamyatin@intel.com>
Date: Mon, 5 Jan 2026 17:51:39 +0100
Subject: [PATCH] Add-SPIRV_ExecutionModeAttributesAttr

---
 .../mlir/Dialect/SPIRV/IR/SPIRVAttributes.td   | 11 +++++++++++
 .../mlir/Dialect/SPIRV/IR/TargetAndABI.h       |  8 ++++++++
 mlir/lib/Conversion/GPUToSPIRV/GPUToSPIRV.cpp  | 14 ++++++++++++++
 mlir/lib/Dialect/SPIRV/IR/SPIRVDialect.cpp     |  4 ++++
 mlir/lib/Dialect/SPIRV/IR/TargetAndABI.cpp     | 18 ++++++++++++++++++
 5 files changed, 55 insertions(+)

diff --git a/mlir/include/mlir/Dialect/SPIRV/IR/SPIRVAttributes.td b/mlir/include/mlir/Dialect/SPIRV/IR/SPIRVAttributes.td
index 1bc3c63646fd..cf5b5ffa451d 100644
--- a/mlir/include/mlir/Dialect/SPIRV/IR/SPIRVAttributes.td
+++ b/mlir/include/mlir/Dialect/SPIRV/IR/SPIRVAttributes.td
@@ -56,6 +56,17 @@ def SPIRV_LinkageAttributesAttr : SPIRV_Attr<"LinkageAttributes", "linkage_attri
   let assemblyFormat = "`<` struct(params) `>`";
 }

+// This attribute specifies SPIR-V execution mode information via GPU functions
+// 1) Execution mode attribute.
+// 2) [optional] Execution mode value.
+def SPIRV_ExecutionModeFuncAttributeAttr : SPIRV_Attr<"ExecutionModeFuncAttribute", "execution_mode_func_attribute"> {
+  let parameters = (ins
+    "mlir::spirv::ExecutionModeAttr":$execution_mode,
+    OptionalParameter<"std::optional<uint32_t>">:$value
+  );
+  let assemblyFormat = "`<` struct(params) `>`";
+}
+
 // Description of cooperative matrix operations supported on the
 // target. Represents `VkCooperativeMatrixPropertiesKHR`. See
 // https://registry.khronos.org/vulkan/specs/1.3-extensions/man/html/VkCooperativeMatrixPropertiesKHR.html
diff --git a/mlir/include/mlir/Dialect/SPIRV/IR/TargetAndABI.h b/mlir/include/mlir/Dialect/SPIRV/IR/TargetAndABI.h
index 24574bfaf619..f64f99294038 100644
--- a/mlir/include/mlir/Dialect/SPIRV/IR/TargetAndABI.h
+++ b/mlir/include/mlir/Dialect/SPIRV/IR/TargetAndABI.h
@@ -137,6 +137,14 @@ FailureOr<ExecutionModel> getExecutionModel(TargetEnvAttr targetAttr);
 /// Returns failure if it cannot be selected.
 FailureOr<MemoryModel> getMemoryModel(TargetEnvAttr targetAttr);

+/// Returns the attribute name for specifying execution mode attribute
+/// information.
+StringRef getExecutionModeFuncAttrName();
+
+/// Queries the Execution Mode Attribute on the nearest function-like op
+/// containing the given `op`. Returns null attribute if not found.
+ExecutionModeFuncAttributeAttr lookupExecModeFuncAttr(Operation *op);
+
 } // namespace spirv
 } // namespace mlir

diff --git a/mlir/lib/Conversion/GPUToSPIRV/GPUToSPIRV.cpp b/mlir/lib/Conversion/GPUToSPIRV/GPUToSPIRV.cpp
index c33a903d0339..a6578465abac 100644
--- a/mlir/lib/Conversion/GPUToSPIRV/GPUToSPIRV.cpp
+++ b/mlir/lib/Conversion/GPUToSPIRV/GPUToSPIRV.cpp
@@ -346,6 +346,20 @@ LogicalResult GPUFuncOpConversion::matchAndRewrite(
     return failure();
   newFuncOp->removeAttr(
       rewriter.getStringAttr(gpu::GPUDialect::getKernelFuncAttrName()));
+
+  auto execModeFuncAttr = spirv::lookupExecModeFuncAttr(funcOp);
+  if (execModeFuncAttr) {
+    spirv::ExecutionModeAttr executionMode =
+        execModeFuncAttr.getExecutionMode();
+    std::optional<uint32_t> modeVal = execModeFuncAttr.getValue();
+
+    OpBuilder::InsertionGuard guard(rewriter);
+    rewriter.setInsertionPointAfter(newFuncOp);
+
+    spirv::ExecutionModeOp::create(rewriter, funcOp.getLoc(), newFuncOp,
+                                            executionMode.getValue(), *modeVal);
+  }
+
   return success();
 }

diff --git a/mlir/lib/Dialect/SPIRV/IR/SPIRVDialect.cpp b/mlir/lib/Dialect/SPIRV/IR/SPIRVDialect.cpp
index 8f02dd856d4e..dfb13c173596 100644
--- a/mlir/lib/Dialect/SPIRV/IR/SPIRVDialect.cpp
+++ b/mlir/lib/Dialect/SPIRV/IR/SPIRVDialect.cpp
@@ -1026,6 +1026,10 @@ LogicalResult SPIRVDialect::verifyOperationAttribute(Operation *op,
   } else if (symbol == spirv::getTargetEnvAttrName()) {
     if (!isa<spirv::TargetEnvAttr>(attr))
       return op->emitError("'") << symbol << "' must be a spirv::TargetEnvAttr";
+  } else if (symbol == spirv::getExecutionModeFuncAttrName()) {
+    if (!isa<spirv::ExecutionModeFuncAttributeAttr>(attr))
+      return op->emitError("'")
+             << symbol << "' must be a spirv::ExecutionModeFuncAttributeAttr";
   } else {
     return op->emitError("found unsupported '")
            << symbol << "' attribute on operation";
diff --git a/mlir/lib/Dialect/SPIRV/IR/TargetAndABI.cpp b/mlir/lib/Dialect/SPIRV/IR/TargetAndABI.cpp
index 8c52ba8b8583..864fc75c53b1 100644
--- a/mlir/lib/Dialect/SPIRV/IR/TargetAndABI.cpp
+++ b/mlir/lib/Dialect/SPIRV/IR/TargetAndABI.cpp
@@ -238,3 +238,21 @@ spirv::getMemoryModel(spirv::TargetEnvAttr targetAttr) {
   }
   return failure();
 }
+
+StringRef spirv::getExecutionModeFuncAttrName() {
+  return "spirv.execution_mode";
+}
+
+spirv::ExecutionModeFuncAttributeAttr
+spirv::lookupExecModeFuncAttr(Operation *op) {
+  while (op && !isa<FunctionOpInterface>(op))
+    op = op->getParentOp();
+  if (!op)
+    return {};
+
+  if (auto attr = op->getAttrOfType<spirv::ExecutionModeFuncAttributeAttr>(
+          spirv::getExecutionModeFuncAttrName()))
+    return attr;
+
+  return {};
+}
--
2.34.1
